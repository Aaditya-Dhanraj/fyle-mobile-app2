<ion-header mode="md">
  <ion-toolbar class="view-reports--toolbar">
    <ion-buttons mode="md" slot="start">
      <button *ngIf="!navigateBack" mat-icon-button [routerLink]="['/','enterprise','my_reports']">
        <mat-icon> keyboard_backspace </mat-icon>
      </button>
      <ion-back-button mode="md" *ngIf="navigateBack"></ion-back-button>
    </ion-buttons>
    <ion-title mode="md" class="page-title"> View Report </ion-title>
    <ion-buttons mode="md" slot="end">
      <ng-container *ngIf="erpt$|async as erpt">
        <ng-container *ngIf="erpt.rp_num_transactions">
          <ion-button class="view-reports--btn-container__btn" (click)="shareReport()">
            <mat-icon svgIcon="share"></mat-icon>
          </ion-button>
        </ng-container>
      </ng-container>
      <ng-container *ngIf="canDelete$ | async">
        <ion-button class="view-reports--btn-container__btn" (click)="deleteReport()">
          <ion-icon [src]="'../../../assets/svg/fy-delete.svg'" slot="icon-only"></ion-icon>
        </ion-button>
      </ng-container>
      <button mat-button class="view-reports--edit" (click)="goToEditReport()" *ngIf="canEdit$|async">Edit</button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="view-reports--container">
  <div class="view-reports--body" *ngIf="erpt$|async as erpt">
    <div>
      <div class="view-reports--card">
        <div class="view-reports--purpose-amount-block">
          <div class="view-reports--purpose-amount-block__purpose">
            {{reportName}}
            <ion-icon
              *ngIf="(canEdit$|async) && erpt && (erpt.rp_state === 'DRAFT' || erpt.rp_state === 'APPROVER_INQUIRY')"
              [src]="'../../../../assets/svg/fy-edit-gradient.svg'"
              slot="icon-only"
              (click)="editReportName()"
              class="view-reports--card-header__icon"
            ></ion-icon>
          </div>
          <div>
            <span class="view-reports--purpose-amount-block__currency">{{ reportCurrencySymbol }}</span>
            <span class="view-reports--purpose-amount-block__amount">
              {{ erpt.rp_amount || 0 | humanizeCurrency: erpt.rp_currency:2:true }}
            </span>
          </div>
        </div>
        <div
          class="text-capitalize view-reports--report-state-pill view-reports--report-state-pill__{{erpt.rp_state | reportState}}"
        >
          {{erpt.rp_state | reportState | snakeCaseToSpaceCase}}
        </div>
      </div>
      <div class="view-reports--date-info-block">
        <div class="view-reports--submitted-date">
          <div>
            <span class="view-reports--submitted-date__text">Submitted on: </span>
            <span class="view-reports--submitted-date__date">{{erpt.rp_created_at | date: 'MMM dd, yyyy'}}</span>
          </div>
        </div>
        <div class="view-reports--view-info" (click)="openViewReportInfoModal()">
          <ion-icon class="view-reports--view-info__icon" src="../../../assets/svg/fy-info-gradient.svg"></ion-icon>
          <span class="view-reports--view-info__content">View Info</span>
        </div>
      </div>

      <div
        class="view-reports--approvers-section"
        *ngIf="(erpt.rp_state !== 'DRAFT') && (reportApprovals$|async) as reportApprovals"
      >
        <div *ngIf="reportApprovals.length > 0" class="view-reports--approval-state-block">
          <div class="view-reports--approvers">Approvers</div>
          <div *ngFor="let ap of reportApprovals">
            <div class="view-reports--approvers-list">
              <div>{{ ap.approver_name }}</div>
              <div class="view-reports--approver-state-section">
                <div
                  class="view-reports--approver-state-pill view-reports--approver-state-pill__{{ap.state | toLowerCase}}"
                ></div>
                <span
                  >{{ ap.state === 'APPROVAL_DONE' ? 'Approved' : (ap.state | titlecase | snakeCaseToSpaceCase)}}</span
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Display Associated trip request info, if there is one. Otherwise don't display this block at all -->
      <div class="view-reports--card" *ngIf="erpt.rp_trip_request_id">
        <div class="view-reports--card-header">Associated Trip Request</div>
        <!-- Display this block if trip requests are handled with T&A module of Fyle -->
        <div class="view-reports--card-body" *ngIf="tripRequest$|async as tripRequest; else showOnlyId">
          <div>Request number is {{tripRequest.trp_request_number}}</div>
          <div>Created on {{tripRequest.trp_created_at | date: 'MMM dd, yyyy'}}</div>
          <div>Purpose: {{tripRequest.trp_purpose}}</div>
        </div>
        <!-- If trip requests are handled externally by the clients, display only the associated trip request ID -->
        <ng-template #showOnlyId>
          <div class="view-reports--card-body">Trip Request ID is {{erpt.rp_trip_request_id}}</div>
        </ng-template>
      </div>

      <div class="view-reports--segment-block-container">
        <ion-segment
          class="segment-block view-reports--segment-block-container__segment"
          (ionChange)="segmentChanged($event)"
          value="expenses"
        >
          <ion-segment-button value="expenses" class="view-reports--segment-block-container__btn text-capitalize">
            Expenses
          </ion-segment-button>
          <ion-segment-button value="comments" class="view-reports--segment-block-container__btn text-capitalize">
            Comments
          </ion-segment-button>
          <ion-segment-button value="history" class="view-reports--segment-block-container__btn text-capitalize">
            History
          </ion-segment-button>
        </ion-segment>

        <div *ngIf="isExpensesView">
          <div *ngIf="erpt.rp_num_transactions > 0">
            <div class="view-reports--divider"></div>
            <div class="view-reports-expense-card-block">
              <div *ngFor="let etxn of etxns$|async as list; let i = index;">
                <app-expense-card
                  [expense]="etxn"
                  [previousExpenseTxnDate]="list[i-1]?.tx_txn_dt"
                  [previousExpenseCreatedAt]="list[i-1]?.tx_created_at"
                  [isSelectionModeEnabled]="selectionMode"
                  [selectedElements]="selectedElements"
                  (goToTransaction)="goToTransaction($event)"
                  (setMultiselectMode)="switchSelectionMode($event)"
                  (cardClickedForSelection)="selectExpense($event)"
                  [isFromReports]="true"
                  [isFromViewReports]="true"
                >
                </app-expense-card>
              </div>
            </div>
            <ng-template #ExpensesLoader>
              <ion-spinner name="crescent"></ion-spinner>
            </ng-template>
          </div>
          <div *ngIf="erpt.rp_num_transactions === 0">
            <div>
              <img src="../../../assets/images/zero-states/expenses.png" alt="No expense in this report" />
              <div class="view-reports--zero-state-header">No expense in this report yet</div>
              <div class="my-create-report--zero-state-header">Looks like you don't have reportable expenses.</div>
              <div class="my-create-report--add-more-container" (click)="addExpense()">
                <mat-icon class="my-create-report--add-more-icon" svgIcon="plus"></mat-icon>
                <div class="my-create-report--add-more-text">Add Expenses</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>

<ion-footer
  *ngIf="((erpt$|async)?.rp_state === 'DRAFT' && (erpt$|async)?.rp_num_transactions !== 0)||(canResubmitReport$ | async)"
>
  <ion-toolbar mode="md">
    <ion-button
      class="view-reports--primary-cta flat-button"
      fill="solid"
      color="fyle-primary"
      expand="block"
      *ngIf="canResubmitReport$ | async"
      (click)="showResubmitReportSummaryPopover()"
    >
      Resubmit Report
    </ion-button>
    <ion-button
      class="view-reports--primary-cta flat-button"
      fill="solid"
      color="fyle-primary"
      expand="block"
      *ngIf="(erpt$|async)?.rp_state === 'DRAFT' && (erpt$|async)?.rp_num_transactions !== 0"
      (click)="showSubmitReportSummaryPopover()"
    >
      Submit Report
    </ion-button>
  </ion-toolbar>
</ion-footer>
